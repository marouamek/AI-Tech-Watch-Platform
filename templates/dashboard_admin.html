<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <title>Decide | Admin Panel</title>
    <link
      rel="stylesheet"
      href="{{ url_for('static', filename='style.css') }}"
    />
    <link
      href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap"
      rel="stylesheet"
    />
    <style>
      .users-table-wrapper {
        margin-top: 20px;
        margin-bottom: 40px;
      }

      .users-table-wrapper h3 {
        font-size: 1.1rem;
        margin-bottom: 15px;
        color: #2d3748;
      }

      .users-table {
        width: 100%;
        border-collapse: collapse;
        background: white;
        border-radius: 8px;
        overflow: hidden;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
      }

      .users-table thead {
        background-color: #f3f4f6;
        border-bottom: 2px solid #e2e8f0;
      }

      .users-table th {
        padding: 15px;
        text-align: left;
        font-weight: 600;
        color: #2d3748;
        font-size: 0.85rem;
        text-transform: uppercase;
        letter-spacing: 0.5px;
      }

      .users-table td {
        padding: 12px 15px;
        border-bottom: 1px solid #e2e8f0;
        color: #4a5568;
      }

      .users-table tbody tr:hover {
        background-color: #f7fafc;
      }

      .role-badge {
        display: inline-block;
        padding: 4px 12px;
        border-radius: 20px;
        font-size: 0.85rem;
        font-weight: 600;
      }

      .role-admin {
        background-color: #fee2e2;
        color: #c53030;
      }

      .role-veilleur {
        background-color: #dbeafe;
        color: #1e40af;
      }

      .role-analyste {
        background-color: #dcfce7;
        color: #166534;
      }

      .role-decideur {
        background-color: #fef3c7;
        color: #92400e;
      }

      .status-badge {
        display: inline-block;
        padding: 4px 12px;
        border-radius: 20px;
        font-size: 0.85rem;
        font-weight: 600;
      }

      .status-active {
        background-color: #dcfce7;
        color: #166534;
      }

      .status-pending {
        background-color: #fef3c7;
        color: #92400e;
      }

      .no-data {
        text-align: center;
        padding: 30px;
        color: #718096;
      }
    </style>
  </head>

  <body>
    <div class="grid-container">
      <!-- Sidebar -->
      {% include 'aside.html' %}

      <!-- Header -->
      <header class="header">
        <h2>Admin Overview</h2>
      </header>

      <!-- Main Content -->
      <main class="main" id="mainContent">
        <!-- OVERVIEW -->
        <div id="section-overview" class="card">
          <div class="card-header">
            <span>Dashboard Overview</span>
            <span class="stat-label">System metrics</span>
          </div>
          <div class="card-content">
            <!-- Statistics Cards -->
            <div class="stats-grid">
              <div class="stat-card">
                <span class="stat-label">Total Users</span>
                <p class="stat-value" id="total-users">0</p>
              </div>
              <div class="stat-card">
                <span class="stat-label">Veilleur</span>
                <p class="stat-value" id="count-veilleur">0</p>
              </div>
              <div class="stat-card">
                <span class="stat-label">Analyste</span>
                <p class="stat-value" id="count-analyste">0</p>
              </div>
              <div class="stat-card">
                <span class="stat-label">Décideur</span>
                <p class="stat-value" id="count-decideur">0</p>
              </div>
              <div class="stat-card">
                <span class="stat-label">Admin</span>
                <p class="stat-value" id="count-admin">0</p>
              </div>
              <div class="stat-card">
                <span class="stat-label">Status</span>
                <p class="stat-value" style="color: #10b981">Active</p>
              </div>
            </div>
          </div>
        </div>

        <!-- Users Table -->
        <div class="card" style="margin-top: 24px">
          <div class="card-header">
            <span>Utilisateurs par rôle</span>
          </div>
          <div class="card-content">
            <div id="users-tables-container"></div>
          </div>
        </div>
      </main>

      <footer class="footer"></footer>
    </div>

    <script>
      // Load statistics and users
      async function loadStatistics() {
        try {
          const statsRes = await fetch("/api/admin/stats");
          const stats = await statsRes.json();

          document.getElementById("total-users").textContent = stats.total || 0;
          document.getElementById("count-admin").textContent = stats.admin || 0;
          document.getElementById("count-veilleur").textContent =
            stats.veilleur || 0;
          document.getElementById("count-analyste").textContent =
            stats.analyste || 0;
          document.getElementById("count-decideur").textContent =
            stats.decideur || 0;
        } catch (err) {
          console.error("Erreur lors du chargement des stats:", err);
        }
      }

      async function loadUsers() {
        try {
          const usersRes = await fetch("/api/admin/users");
          const data = await usersRes.json();
          const users = data.users || [];

          // Grouper les utilisateurs par rôle
          const usersByRole = {
            admin: [],
            veilleur: [],
            analyste: [],
            decideur: [],
          };

          users.forEach((user) => {
            if (usersByRole[user.role]) {
              usersByRole[user.role].push(user);
            }
          });

          // Générer les tables
          const container = document.getElementById("users-tables-container");
          container.innerHTML = "";

          const roleLabels = {
            admin: "Administrateurs",
            veilleur: "Veilleurs",
            analyste: "Analystes",
            decideur: "Décideurs",
          };

          Object.keys(usersByRole).forEach((role) => {
            const roleUsers = usersByRole[role];

            let tableHTML = `
                        <div class="users-table-wrapper">
                            <h3>${roleLabels[role]} (${roleUsers.length})</h3>
                    `;

            if (roleUsers.length === 0) {
              tableHTML += '<p class="no-data">Aucun utilisateur</p>';
            } else {
              tableHTML += `
                            <table class="users-table">
                                <thead>
                                    <tr>
                                        <th>ID</th>
                                        <th>Nom d'utilisateur</th>
                                        <th>Email</th>
                                        <th>Rôle</th>
                                        <th>État</th>
                                    </tr>
                                </thead>
                                <tbody>
                        `;

              roleUsers.forEach((user) => {
                const statusClass = user.is_first_login
                  ? "status-pending"
                  : "status-active";
                const statusText = user.is_first_login
                  ? "1ère connexion"
                  : "Actif";

                tableHTML += `
                                <tr>
                                    <td>${user.id}</td>
                                    <td>${user.username}</td>
                                    <td>${user.email}</td>
                                    <td><span class="role-badge role-${user.role}">${user.role}</span></td>
                                    <td><span class="status-badge ${statusClass}">${statusText}</span></td>
                                </tr>
                            `;
              });

              tableHTML += `
                                </tbody>
                            </table>
                        `;
            }

            tableHTML += "</div>";
            container.innerHTML += tableHTML;
          });
        } catch (err) {
          console.error("Erreur lors du chargement des utilisateurs:", err);
        }
      }

      // Charger les données au démarrage
      document.addEventListener("DOMContentLoaded", () => {
        loadStatistics();
        loadUsers();

        // Rien à faire ici pour le surlignage : géré via request.endpoint dans aside.html
      });
      // La création de compte se fait sur la page dédiée admin_create_account.html
    </script>
  </body>
</html>
